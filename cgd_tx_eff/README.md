# CGD Transcript Effects

The python modules in this directory are used to gather transcript information with proper HGVS nomenclature for import into CGD. 

The main modules are: 
* ``tx_eff_control.py``		receives all parameters and calls the other modules in order 
* ``tx_eff_annovar.py``		parses the Annovar variant_function and exonic_variant_function files
* ``tx_eff_hgvs.py``		retrieves transcript effects from UTA using the hgvs package
* ``tx_eff_ccds.py``		maps RefSeq transcript accessions to CCDS
* ``tx_eff_annotate.py``	add additional annotation (eg reference sequence)
* ``tx_eff_writer.py``		write transcript effects to output file 

## Configuration 

### Install Annovar

### Install HGVS

## Annovar

Before running Annovar you must first convert the variant list to a format Annovar understands. Annovar provides the ``convert2annovar.pl`` that can convert from most formats but we are exporting data from CGD in a json file so we have our own script for converting to Annovar's input format. 

```
python $TFX_HOME/src/edu/ohsu/compbio/txeff/util/json_to_annovar.py --in cgd_variants.json --out annovar.avinput
```

Run Annovar with the following parameters to add RefSeq transcripts and identify splice variants. 

```
./annotate_variation.pl -geneanno \
                        -out $PWD/annovar      \
                        -build hg19            \
                        $PWD/annovar.avinput   \
                        $ANNOVAR_HOME/humandb/ \
                        --transcript_function  \
                        --hgvs                 \
                        --separate             \
                        --dbtype               \
                        refGeneWithVer         \
                        --otherinfo            \
                        --splicing_threshold 5 \
                        --exonicsplicing
```

The ``annotate_variation.pl`` script generates two output files: 
* ``annovar.exonic_variant_function``
* ``annovar.variant_function``

## The Transcript Effects Modules


### tx_eff_control.py 

The ``tx_eff_control.py`` script is the interface for calling the other five modules. It takes the following parameters:

* ``--annovar_exonic_variant_function``	required		output from Annovar containing amino acid changes resulting from exonic variants. 
* ``--annovar_variant_function``			required		output from Annovar containing annotation for all variants 
* ``--ccds_map``						required		a csv file with RefSeq to CCDS mappings
* ``--out``							required	 	the output file name that will be written in json format
* ``--reference_fasta``					required		the reference genome, in FASTA format.  The associated index is expected to be in the same directory
* ``--benchmark``						optional		causes benchmarking information to file. this parameter can not be used when ``--threads`` are greater than 1.
* ``--sequence_source``					optional		indicate how to find the SeqRepo utility. Valid parameters are a url (eg http://127.0.0.1:5000/seqrepo) or file path (eg /opt/seqrepo/2024-05-23). 
* ``--threads``						optional		the number of threads to use (default 1)
* ``--variants``						optional		the json list of variants exported from CGD. When this file is provided an additional validation step is performed to see 
if there are variants that were requested but did not make it into the output. 
* ``--version``						optional		prints the transcript effects version and exits

Example of how to run ``tx_eff_control.py``:

```
python src/edu/ohsu/compbio/txeff/tx_eff_control.py --variants cgd_variants.json \
                                                    --ccds_map /opt/transcript_effects/datasources/GRCh37_refseq_ccds_mapping_20241115.csv \
                                                    --reference_fasta /opt/bioinformatics/Broad/Homo_sapiens_assembly19.fasta \
                                                    --annovar_variant_function annovar.variant_function \
                                                    --annovar_exonic_variant_function annovar.exonic_variant_function \
                                                    --out out.json \
                                                    --threads 2 \
                                                    --sequence_source /opt/transcript_effects/hgvs/seqrepo/2024-05-23

```

### tx_eff_annovar.py

The ``tx_eff_annovar.py`` module reads the ``*.exonic_variant_function`` and ``*.variant_function`` files generated by Annovar and  merges the information from the two files into one record for each transcript. 

### tx_eff_hgvs.py

The ``tx_eff_hgvs.py`` module takes as input the transcripts generated by ``tx_eff_annovar.py``, fixes the nomenclature using the HGVS python library, and looks for additional transcripts in the UTA database. 

### tx_eff_ccds.py

The ``tx_eff_vcf.py`` script takes the transcripts generated by ``tx_eff_hgvs.py`` and , looks up each RefSeq id in the RefSeq to CCDS map, and creates a copy of the RefSeq transcript and changes the accession to CCDS.  

### tx_eff_annotate.py

Add additional annotations to the transcript effects VCF. 

### tx_eff_writer.py

The ``tx_eff_writer.py`` module takes as input the transcript list and writes them out to a json file.

Example output:
```json
[
  {
    "id": "709552",
    "chromosome": "22",
    "position": 30765502,
    "reference": "G",
    "alt": "A",
    "variantEffect": "synonymous SNV",
    "variantType": "exonic",
    "aminoAcidPosition": 110,
    "basePosition": 330,
    "exon": 4,
    "gene": "CCDC157",
    "cDot": "c.330G>A",
    "pDot1": "p.A110=",
    "pDot3": "p.Ala110=",
    "splicing": null,
    "cdnaTranscript": "NM_001017437.3",
    "proteinTranscript": "NP_001017437.2",
    "sequenceVariant": "g.30765502G>A",
    "referenceContext": "CACAGGCTGCGGGGCCCTGCA"
  }
]  
```

## Additional Utilities

### avinput2vcf.py

Convert an Annovar input file to a VCF. 

### benchmarking.py 

A benchmarking package we wrote for this project. 

### hgvs_lookup_py

Command line tool to Lookup a genotype using the biocommons-hgvs package and the UTA database. 

### json_to_annovar.py

Conver a list of variants in json format to Annovar avinput format. 

### print_tfx.py

Command line tool to read a VCF with transcript effect annotations and display them in tabular format.
